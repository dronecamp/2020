---
title: "Read data"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r read_data, include=FALSE}
day_tagln <- list()
day_tagln[["2020-06-22"]] <- "Things you should know BEFORE going to the field"
day_tagln[["2020-06-23"]] <- "Things you should know IN the field; Image Processing Part 1"
day_tagln[["2020-06-24"]] <- "Image Processing Part 2; GIS Analysis Part 1"
day_tagln[["2020-06-25"]] <- "Participant Talks; Advanced Flight Ops; GIS Analysis Part 2; Deeper Dives by Field"

day_col <- list()
day_col[["Sunday"]] <- "#6a3d9a"
day_col[["Monday"]] <- "#a65628"
day_col[["Tuesday"]] <- "#377eb8"
day_col[["Wednesday"]] <- "#984ea3"
day_col[["Thursday"]] <- "#008080"
day_col[["Friday"]] <- "#cab2d6"
day_col[["Saturday"]] <- "#ff7f00"

if (params$download_wrkshp) {
  ## (re)Downloading workshop data from Google Sheets
  
  library(googlesheets4)
  sheets_auth(email = "andlyons@ucdavis.edu")
  dc20_wkshps_id <- "1A6DdBJH-ZZbMHb9Y7HFCqJBjPXmWy92C0rVEyYqhRqw"
  
  ## Download the 'Workshops - Responses' sheet
  dc20_wkshps_tbl <- googlesheets4::range_read(ss = dc20_wkshps_id, 
                                               sheet = "Workshops - Responses", range = NULL)
  
  ## Download the 'Tracks' sheet
  tracks_tbl <- googlesheets4::range_read(ss = dc20_wkshps_id, sheet = "Tracks", range = NULL)

  ## Download the 'Substitutions' sheet
  subst_tbl <- googlesheets4::range_read(ss = dc20_wkshps_id, sheet = "Substitutions", range = NULL)
 
  ## Write the time of this download in the Google Sheet
  googlesheets4::range_write(ss = dc20_wkshps_id, data = data.frame(val = Sys.time()),
                           sheet = "Options", range = "B2", col_names = FALSE, reformat = FALSE)

  save(dc20_wkshps_tbl, file="dc20_wkshps_tbl.RData")
  save(subst_tbl, file="subst_tbl.RData")
  save(tracks_tbl, file="tracks_tbl.RData")
  
} else {
  ## Using cached workshop data
  load("dc20_wkshps_tbl.RData")
  load("subst_tbl.RData")
  load("tracks_tbl.RData")
}

cols_core <- c("title" = "Workshop Title", 
              "blurb" = "Workshop Short Blurb", 
              "desc" = "Workshop Description", 
              "format" = "Workshop Format", 
              "inst1_name" = "Instructor #1 - Name", 
              "inst1_email" = "Instructor #1 - Email", 
              "inst2_name" = "Instructor #2 - Name", 
              "inst2_email" = "Instructor #2 - Email", 
              "inst3_name" = "Instructor #3 - Name", 
              "inst3_email" = "Instructor #3 - Email", 
              "duration" = "Duration", 
              "prereqs" = "Prerequisite(s)", 
              "max_partic" = "Max Number of Participants", 
              "software" = "Software Needed", 
              "pc" = "Personal Laptops", 
              "instructions" = "Additional Instructions to Participants", 
              "res01_name" = "Resource #1 - Name", 
              "res01_url" = "Resource #1 - URL", 
              "res02_name" = "Resource #2 - Name", 
              "res02_url" = "Resource #2 - URL", 
              "res03_name" = "Resource #3 - Name", 
              "res03_url" = "Resource #3 - URL", 
              "res04_name" = "Resource #4 - Name", 
              "res04_url" = "Resource #4 - URL", 
              "prereg" = "Pre-Registration Required", 
              "dt_readable" = "Date & Time", 
              "track_namedt" = "Track", 
              "zoom_url" = "Zoom URL", 
              "facilitator" = "Zoom Facilitator", 
              "tags" = "Tags", 
              "wkshp_dtsort" = "SortableTimeSlot",
              "eval_url" = "Evaluation Form URL",
              "thumb_url" = "Thumbnail Image URL", 
              "program_ok" = "Ready to go on the DroneCamp Program", 
              "record_url" = "Recorded Video - URL", 
              "record_release" = "Recorded Video - OK to Release")


ws_all <- dc20_wkshps_tbl %>% select(all_of(cols_core)) %>% 
  mutate(session_date = as.Date(substr(wkshp_dtsort, 1, 10)))

## JOIN THE TRACKS

cols_tracks <- c("track_nameonly" = "Track Title", 
                 "track_namedt" = "TitleTimeSlot",
                 "track_type" = "Type",
                 "track_dtsort" = "SortableTimeSlot")

tracks_tbl <- tracks_tbl %>% select(all_of(cols_tracks))

ws_all <- ws_all %>% left_join(tracks_tbl, by = "track_namedt")

## Fill the missing track times with the workshop time
(track_nodt_idx <- which(is.na(ws_all$track_dtsort)))
ws_all[track_nodt_idx, "track_dtsort"] <- ws_all[track_nodt_idx, "wkshp_dtsort"]
ws_all[track_nodt_idx, "track_nameonly"] <- "none"

## DO THE SUBSTITUTIONS

## Create a function to process one vector of character vals
subst_col <- function(char_vals, findreplace_tbl) {
  for (i in 1:nrow(subst_tbl)) {
    char_vals <- gsub(subst_tbl$LookFor[i], subst_tbl$ReplaceWith[i], char_vals, fixed = TRUE)
  }
  char_vals
}

## Define the columns to process substitutions
flds <- c("title", "blurb", "desc", "prereqs", "software", "instructions", 
          "prereg", "eval_url", "record_url", "zoom_url")

ws_all <- ws_all %>% mutate_at(flds, subst_col, findreplace_tbl = subst_tbl)

```
